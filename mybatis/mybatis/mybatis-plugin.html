<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MyBatis 插件 :: Implicated</title>
    <link rel="canonical" href="https://docs.implicated.com/mybatis/mybatis/mybatis-plugin.html">
    <link rel="prev" href="mybatis-sql.html">
    <link rel="next" href="../mybatis-spring/mybatis-spring-integrations.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.implicated.com">Implicated</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="mybatis" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Learn MyBatis</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../introduction.html">基本介绍</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">MyBatis</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mybatis-component.html">MyBatis 的组成</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mybatis-init.html">MyBatis 初始化流程</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mybatis-sql.html">MyBatis 执行流程</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="mybatis-plugin.html">MyBatis 插件</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">MyBatis Spring</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../mybatis-spring/mybatis-spring-integrations.html">Spring 整合 MyBatis 原理</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../mybatis-spring/mybatis-spring-configuration.html">MyBatis-Spring 配置项</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">MyBatis 衍生框架</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../mybatis-tk/tk.html">TkMyBatis</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../mybatis-tk/page-helper.html">PageHelper</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../mybatis-plus/mybatis-plus.html">MyBatis-Plus</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../ref.html">参考文档</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Learn MyBatis</a></li>
    <li>MyBatis</li>
    <li><a href="mybatis-plugin.html">MyBatis 插件</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">MyBatis 插件</h1>
<div class="sect1">
<h2 id="插件的加载"><a class="anchor" href="#插件的加载"></a>插件的加载</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="mybatis"><a class="anchor" href="#mybatis"></a>mybatis</h3>
<div class="listingblock">
<div class="title">org.apache.ibatis.builder.xml.XMLConfigBuilder#parseConfiguration</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseConfiguration</span><span class="hljs-params">(XNode root)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// ignore</span>
        pluginElement(root.evalNode(<span class="hljs-string">&quot;plugins&quot;</span>));
        <span class="hljs-comment">// ignore</span>
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error parsing SQL Mapper Configuration. Cause: &quot;</span> + e, e);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mybatis-spring-boot-starter"><a class="anchor" href="#mybatis-spring-boot-starter"></a>mybatis-spring-boot-starter</h3>
<div class="listingblock">
<div class="title">org.mybatis.spring.SqlSessionFactoryBean#buildSqlSessionFactory</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java"><span class="hljs-keyword">protected</span> SqlSessionFactory <span class="hljs-title function_">buildSqlSessionFactory</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// ignore</span>
    <span class="hljs-keyword">if</span> (!isEmpty(<span class="hljs-built_in">this</span>.plugins)) {
        Stream.of(<span class="hljs-built_in">this</span>.plugins).forEach(plugin -&gt; {
            targetConfiguration.addInterceptor(plugin);
            LOGGER.debug(() -&gt; <span class="hljs-string">&quot;Registered plugin: &#x27;&quot;</span> + plugin + <span class="hljs-string">&quot;&#x27;&quot;</span>);
        });
    }
    <span class="hljs-comment">// ignore</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.sqlSessionFactoryBuilder.build(targetConfiguration);
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="插件的执行"><a class="anchor" href="#插件的执行"></a>插件的执行</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="../_images/load-plugins.png" alt="load plugins">
</div>
</div>
<div class="listingblock">
<div class="title">org.apache.ibatis.plugin.InterceptorChain#pluginAll</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">pluginAll</span><span class="hljs-params">(Object target)</span> {
    <span class="hljs-comment">// 循环应用插件，加载顺序 1-&gt;2-&gt;3 ，执行顺序 3-&gt;2-&gt;1-&gt;x-&gt;1-&gt;2-&gt;3</span>
    <span class="hljs-keyword">for</span> (Interceptor interceptor : interceptors) {
        <span class="hljs-comment">// 责任链</span>
        target = interceptor.plugin(target);
    }
    <span class="hljs-comment">// 返回最终代理对象</span>
    <span class="hljs-keyword">return</span> target;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="可以拦截的方法"><a class="anchor" href="#可以拦截的方法"></a>可以拦截的方法</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Executor (update, query, flushStatements, commit, rollback, getTransaction, close, isClosed)</p>
</li>
<li>
<p>ParameterHandler (getParameterObject, setParameters)</p>
</li>
<li>
<p>ResultSetHandler (handleResultSets, handleOutputParameters)</p>
</li>
<li>
<p>ResultSetHandler(handleResultSets，handleOutputParameters)</p>
</li>
<li>
<p>StatementHandler (prepare, parameterize, batch, update, query)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="实现方式"><a class="anchor" href="#实现方式"></a>实现方式</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="实现-interceptor-接口"><a class="anchor" href="#实现-interceptor-接口"></a>实现 <code>Interceptor</code> 接口。</h3>
<div class="listingblock">
<div class="title">org.apache.ibatis.plugin.Interceptor</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Interceptor</span> {

    <span class="hljs-comment">// 拦截逻辑</span>
    Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Invocation invocation)</span> <span class="hljs-keyword">throws</span> Throwable;

    <span class="hljs-comment">// 触发逻辑</span>
    <span class="hljs-keyword">default</span> Object <span class="hljs-title function_">plugin</span><span class="hljs-params">(Object target)</span> {
        <span class="hljs-keyword">return</span> Plugin.wrap(target, <span class="hljs-built_in">this</span>);
    }

    <span class="hljs-comment">// 初始化逻辑</span>
    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties properties)</span> {
    }

}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="添加-intercepts-注释"><a class="anchor" href="#添加-intercepts-注释"></a>添加 <code>Intercepts</code> 注释</h3>
<div class="listingblock">
<div class="title">org.apache.ibatis.plugin.Intercepts</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java"><span class="hljs-meta">@Documented</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Target(ElementType.TYPE)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Intercepts {
    <span class="hljs-comment">/**
     * 返回要截取的方法签名。
     */</span>
    Signature[] value();
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">org.apache.ibatis.plugin.Signature</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java"><span class="hljs-meta">@Documented</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Target({})</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Signature {
    <span class="hljs-comment">/**
     * 切入类
     */</span>
    Class&lt;?&gt; type();

    <span class="hljs-comment">/**
     * 切入方法
     */</span>
    String <span class="hljs-title function_">method</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 切入方法的参数
     */</span>
    Class&lt;?&gt;[] args();
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="example"><a class="anchor" href="#example"></a>Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java"><span class="hljs-meta">@Intercepts({
        @Signature(type = Executor.class, method = &quot;query&quot;, args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class}),
        @Signature(type = Executor.class, method = &quot;query&quot;, args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class, CacheKey.class, BoundSql.class}),
        @Signature(type = Executor.class, method = &quot;update&quot;, args = {MappedStatement.class, Object.class})
})</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoPlugin</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Interceptor</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Invocation invocation)</span> <span class="hljs-keyword">throws</span> Throwable {
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">plugin</span><span class="hljs-params">(Object target)</span> {
        <span class="hljs-keyword">return</span> Plugin.wrap(target, <span class="hljs-built_in">this</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties properties)</span> {

    }

}</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="mybatis-sql.html">MyBatis 执行流程</a></span>
  <span class="next"><a href="../mybatis-spring/mybatis-spring-integrations.html">Spring 整合 MyBatis 原理</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>Last updated on 2023-06-07 09:25:18</p>
</footer>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
